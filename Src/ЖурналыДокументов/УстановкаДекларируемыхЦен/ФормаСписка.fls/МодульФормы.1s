//*****************************************************************************
// Описание переменных 
Перем СписокДействий;  // Список действий по документу
Перем ОснВал;

Процедура РассчитатьЦены(ДокУ,ТЗЦен, ОтКоэф, Кат)
	ТЗЦен.ВыбратьСтроки();
	Пока ТЗЦен.ПолучитьСтроку() = 1 Цикл
		Если ДокУ.ЦенаОт < ТЗЦен.Предел Тогда
			Если ОтКоэф = 1 Тогда
				ДокУ.Цена = Окр(глПересчет(ДокУ.ЦенаОт*ТЗЦен.Коэф,ОснВал,ДокУ.ДатаДок,ДокУ.Валюта,ДокУ.ДатаДок), 0);
			Иначе
				ДокУ.Цена = Окр(глПересчет(ДокУ.ЦенаОт+ТЗЦен.Наценка,ОснВал,ДокУ.ДатаДок,ДокУ.Валюта,ДокУ.ДатаДок), 0);
			КонецЕсли;
		    
			Если (ДокУ.Валюта <> ОснВал) и (Кат.НеОкруглятьЦену = 0) Тогда
			    ЧисОкр = Число(Прав(Строка(ДокУ.Цена), 1));
				Если (ЧисОкр > 1) и (ЧисОкр <=5) Тогда
				    ЧисОкр = 5;
				ИначеЕсли (ЧисОкр = 0) Тогда
					ДокУ.Цена = ДокУ.Цена - 1;
					Прервать;
				Иначе
					ЧисОкр = 9;
				КонецЕсли;
				СтрЦена = Строка(ДокУ.Цена);
				ДокУ.Цена = Число(Лев(СтрЦена, СтрДлина(СтрЦена) - 1) + ЧисОкр);					
			КонецЕсли;
			Прервать;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура СформироватьУстановкиЦен()
	Если ПустоеЗначение(ТекущийДокумент) = 1 Тогда
		Предупреждение("Не выбран документ");
		Возврат;		
	КонецЕсли;
	Если ТекущийДокумент.Категория.Оптовая = 0 Тогда
		Предупреждение("В документе не оптовая категория цен");
		Возврат;		
	КонецЕсли;
	Если ТекущийДокумент.Проведен() = 0 Тогда
		Если Вопрос("Документ не проведен. Продолжить?", "Да+Нет") = "Нет" Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	Если Вопрос("Создать установки цен?", "Да+Нет") = "Нет" Тогда
		Возврат;
	КонецЕсли;
	
	ТЗ = СоздатьОбъект("ТаблицаЗначений");
	ТекущийДокумент.ВыгрузитьТабличнуюЧасть(ТЗ);
	
	СпрКЦ = СоздатьОбъект("Справочник.КатегорииЦен");
	ОснВал = Константа.ОсновнаяВалюта;
	ДокУ = СоздатьОбъект("Документ.УстановкаЦенТМЦ");
	СпрКЦ.ВыбратьЭлементы();
	Пока СпрКЦ.ПолучитьЭлемент() = 1 Цикл		
		Если СпрКЦ.АвтФормирование = 0 Тогда
			Продолжить;
		КонецЕсли;
		ТЗЦен = СоздатьОбъект("ТаблицаЗначений");
		ТЗЦен.НоваяКолонка("Предел", "Число");
		ТЗЦен.НоваяКолонка("Наценка", "Число");
		ТЗЦен.НоваяКолонка("Коэф", "Число");
	
		СпрГрад = СоздатьОбъект("Справочник.ГрадацииЦен");
		СпрГрад.ИспользоватьВладельца(СпрКЦ.ТекущийЭлемент());
		СпрГрад.ВыбратьЭлементы();
		Пока СпрГрад.ПолучитьЭлемент() = 1 Цикл
			Если СпрГрад.ПометкаУдаления() = 0 Тогда
			    ТЗЦен.НоваяСтрока();
				ТЗЦен.Предел = СпрГрад.Предел;
				ТЗЦен.Наценка = СпрГрад.Наценка;
				ТЗЦен.Коэф = СпрГрад.Коэф;
			КонецЕсли;
		КонецЦикла;
		ТЗЦен.Сортировать("Предел");
	
		ДокУ.Новый();
		ДокУ.Категория = СпрКЦ.ТекущийЭлемент();
		ДокУ.КатегорияОт = ТекущийДокумент.Категория;
		ДокУ.ВалютаШ = Гривня;
		ТЗ.ВыбратьСтроки();
		Пока ТЗ.ПолучитьСтроку() = 1 Цикл
			ДокУ.НоваяСтрока();
			ДокУ.Товар = ТЗ.Товар;
			ДокУ.Сертификация = ТЗ.Сертификация;
			ДокУ.ЦенаОт = глПересчет(ТЗ.Цена,ТЗ.Валюта,ДокУ.ДатаДок,Константа.ОсновнаяВалюта,ДокУ.ДатаДок);
			ДокУ.Валюта = Гривня;
			РассчитатьЦены(ДокУ, ТЗЦен, СпрКЦ.СчитатьОтКоэф, СпрКЦ.ТекущийЭлемент());
		КонецЦикла;
		
		Если ДокУ.КоличествоСтрок() > 0 Тогда
			ДокУ.Записать();
			ДокУ.Провести();
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

//*****************************************************************************
//Инициализирум список действий по кнопке "Действия"
СписокДействий = глПолучитьСписокДействий("
	|СтруктураПодчиненности,
	|ДвиженияДокумента,
	|ВводНаОсновании,
	|Подчиненные");
