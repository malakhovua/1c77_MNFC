Перем Инфо, тбВозврат;
Перем СтарыйКонтрагент;
Перем СписокДействий;
Перем НачальнаяДатаДокумента;

// + umk
Процедура УстановитьВидимость()
	
	Перем Представление;
	
	ВидимостСчЗатрат = 0;
	
	сВидОперации.ПолучитьЗначение(сВидОперации.ТекущаяСтрока(),Представление);
	
	Если Представление = "Эквайринг" Тогда
		ВидимостСчЗатрат = 1;
		Форма.БанкУслуги.Заголовок("% банка " + Строка(РСчет.БанковскиеУслуги.Получить(ДатаДок)));
	КонецЕсли;
	
	Форма.БанкУслуги.Видимость(ВидимостСчЗатрат);
	Форма.СчетЗатрат.Видимость(ВидимостСчЗатрат);
	Форма.ЗаголовокСчЗатрат.Видимость(ВидимостСчЗатрат);

КонецПроцедуры

Процедура ПриИзмененииДата()
	УстановитьВидимость();
КонецПроцедуры

Процедура УстВидимостьСуммыГрн()
	Если РСчет.Валюта <> Гривня Тогда
		
		Форма.тВалюта.Видимость(1); 	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
		Форма.Валюта.Видимость(1);		//--- УМК Сандомирский В.Ю. (08.09.14) Валюта	
	//	Форма.тКратность.Видимость(1); 	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
	//	Форма.Кратность.Видимость(1);	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
		Форма.тКурс.Видимость(1);		//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
		Форма.Курс.Видимость(1);		//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
	
		Форма.тСуммаГрнПост.Видимость(1);
		Форма.СуммаГрнПост.Видимость(1);
		
	Иначе
		
		Форма.тВалюта.Видимость(0); 	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
		Форма.Валюта.Видимость(0);		//--- УМК Сандомирский В.Ю. (08.09.14) Валюта	
	//	Форма.тКратность.Видимость(0); 	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
	//	Форма.Кратность.Видимость(0);	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта	
		Форма.тКурс.Видимость(0); 		//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
		Форма.Курс.Видимость(0);		//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
				
		Форма.тСуммаГрнПост.Видимость(0);
		Форма.СуммаГрнПост.Видимость(0);	
		
	КонецЕсли;
КонецПроцедуры

// ===============================
Функция УстДоступность()
	
		
	Форма.кПравоваяПоддержка.Видимость(глВидимостьПравовойПоддержки);
	Форма.Фирма.Видимость(0);
	Форма.Заголовок(глЗаголовок(Контекст,"Приходный кассовый ордер"));
	Форма.кИнфо.Доступность(РСчет.Выбран());

	Если (глПользователь.фПривелегииДатаЗапрета = 1) И  (Выбран() = 1) Тогда  //--- УМК Сандомирский В.Ю. (13.08.14)  возможно менять договор привелегированым
		Форма.кОсн.Доступность(1);
		Форма.кОК.Доступность(1);
	КонецЕсли;
		
	// установим субконто
	Для Инд = 1 По 3 Цикл
		Форма.ПолучитьАтрибут("Субконто"+Инд).Доступность(?(Инд<=Счет.КоличествоСубконто(),1,0));
	КонецЦикла;

	Форма.Субконто1.Видимость(1);
	Если ((глСчетаПоставщиковПокупателей.Принадлежит(Число(СтрЗаменить(Счет.Код,".","")))<>0)
	ИЛИ (Счет.ПринадлежитГруппе(СчетПоКоду("70"))=1)) Тогда
		фВзаиморасчеты = 1;
	Иначе
		фВзаиморасчеты = 0;
	КонецЕсли;
	Форма.НДС.Доступность(фВзаиморасчеты);
	Форма.тНДС.Доступность(фВзаиморасчеты);
	Форма.ВидНДС.Доступность(фВзаиморасчеты);
	Форма.тВидНДС.Доступность(фВзаиморасчеты);
	Форма.ВидОплаты.Доступность(фВзаиморасчеты);
	Форма.тВидОплаты.Доступность(фВзаиморасчеты);
	
	Если (Форма.ВидНДС.Доступность() = 0) И (НДС <> 0) Тогда
		НДС = 0;
	КонецЕсли;

	Если Форма.Закладки.ТекущаяСтрока() = 2 Тогда
		Если РСчет.Выбран() = 1 Тогда
			Форма.ОперационнаяКР.Видимость(?(РСчет.Валюта=Гривня,0,1));
			Форма.Примечание.Видимость(1-Форма.ОперационнаяКР.Видимость());
			Форма.тПримечание.Видимость(1-Форма.ОперационнаяКР.Видимость());
		КонецЕсли;
	КонецЕсли;
	
	Если ВидОплаты = Перечисление.ВидыОплаты.Оплата Тогда
		Форма.КонечныйПотребитель.Доступность(1);
	Иначе
		Форма.КонечныйПотребитель.Доступность(0);
		Если КонечныйПотребитель = 1 Тогда
			КонечныйПотребитель = 0;
		КонецЕсли;
	КонецЕсли;
	
	Если НазваниеНабораПрав() = "Заказ" Тогда
		Форма.кнПечать.Доступность(1-Макс(Модифицированность(), 1-ТекущийДокумент().Выбран()));
	КонецЕсли;

	Возврат "";
КонецФункции

// ===============================
Функция УстСлои()
	Слои = ",Субконто";
	Если (глСчетаПоставщиковПокупателей.Принадлежит(Число(СтрЗаменить(Счет.Код,".",""))) <> 0) Тогда
		Слои = ",Взаиморасчеты";
	КонецЕсли;
	Возврат Слои;
КонецФункции

// ===============================
Процедура ПриВыбореЗакладки(Номер,Значение)
	Форма.ИспользоватьСлой("Общий,"+Значение+УстСлои(),2);
КонецПроцедуры

// ===============================
Процедура ИзмВидНДС()
	Ст = ВидНДС.Ставка.Получить(ДатаДок);
	НДС = СуммаВал*Ст/(1+Ст);
КонецПроцедуры

// ===============================
Процедура ИзмСчет(ВводНового=0)
	Для Инд = 1 По 3 Цикл
		НазначитьТип("Субконто"+Инд,Счет.ВидСубконто(Инд));
		Если Инд > Счет.КоличествоСубконто() Тогда
			УстановитьАтрибут("Субконто"+Инд, 0);
		КонецЕсли;
	КонецЦикла;

	Если глСчетаПоставщиковПокупателей.Принадлежит(Число(Счет.Код)) = 1 Тогда
		Если ПустоеЗначение(ВидНДС) = 1 Тогда
		    ВидНДС = глВосстановитьЗначение(Контекст,"БазНДС",ОсновнаяСтавкаНДС);
		КонецЕсли;
	Иначе                		
		ДокументДоговор = ПолучитьПустоеЗначение("Документ");
		ДокументОснование = ПолучитьПустоеЗначение("Документ");
		Основание = "";
		ВидНДС = неНДС;
	КонецЕсли;
	ИзмВидНДС();

	Если Счет.Выбран() = 0 Тогда
		ТекЗакл = Форма.Закладки.ТекущаяСтрока();
		ПриВыбореЗакладки(ТекЗакл, Форма.Закладки.ПолучитьЗначение(ТекЗакл));
	    Возврат;
	КонецЕсли;

	Группа = Сред(Счет.Код,1,3);
	Если (Группа = "371") или (Группа = "681") Тогда
		глКомментарий("Для отражения авансовых оплат используйте счет покупателей 36 или счет поставщиков 63. Авансы будут определены автоматически.",0,,"I");
		Если Группа = "371" Тогда
			Группа = "63";
		ИначеЕсли Группа = "681" Тогда
			Группа = "36";
		КонецЕсли;
	ИначеЕсли Группа <> "372" Тогда
	    Группа = Сред(Счет.Код,1,2);
	КонецЕсли;

	Если (Группа = "372") Или (Группа = "31") Или (Группа = "36") Или (Группа = "63") Тогда
		ПравСимв = Прав(Счет.Код,1); 
		Если РСчет.Валюта = Гривня Тогда
			Если (ПравСимв <> "1") и (ПравСимв <> "3") Тогда
				ПравСимв = "1";
			КонецЕсли
		Иначе 
			Если (ПравСимв <> "2") и (ПравСимв <> "4") Тогда
				ПравСимв = "2";
			КонецЕсли
		КонецЕсли;
	    НовСчет = СчетПоКоду(СокрЛП(Группа) + ПравСимв);
	    Если НовСчет <> Счет Тогда
	    	Счет = НовСчет;
	    КонецЕсли;
	КонецЕсли;

	Если Группа = "36" Тогда
		ВидПриходаДенег = Перечисление.ВидыПриходаДенег.ВыручкаОтРеализации;
	Иначе
		ВидПриходаДенег = Перечисление.ВидыПриходаДенег.ПрочийПриход;
	КонецЕсли;

	Если (Счет.ВидСубконто(2) = ВидыСубконто.МесяцНачисленияЗП) И (ПустоеЗначение(Субконто2) = 1) Тогда
	    Субконто2 = НачМесяца(ДатаДок);
	КонецЕсли;

	Если ВводНового = 0 Тогда
		ТекЗакл = Форма.Закладки.ТекущаяСтрока();
		ПриВыбореЗакладки(ТекЗакл, Форма.Закладки.ПолучитьЗначение(ТекЗакл));
	КонецЕсли;
	
КонецПроцедуры

// ===============================
Процедура ИзмВидОперации()
	
	Перем Представление; // + umk
	
	Значение = сВидОперации.ПолучитьЗначение(сВидОперации.ТекущаяСтрока(),Представление);
	Позиция = Найти(Значение,",");
	Счет = СчетПоКоду(Сред(Значение,1,?(Позиция <> 0,Позиция-1,СтрДлина(Значение))));
	
	// + umk
	Если Представление = "Эквайринг" Тогда
		СчетЗатрат = СчетПоКоду(Сред(Значение,?(Позиция <> 0,Позиция + 1, 0),СтрДлина(Значение) - Позиция)) 	
	Иначе
		СчетЗатрат = ПолучитьПустоеЗначение();
	КонецЕсли;
	// + umk
	ИзмСчет();
	УстановитьВидимость();// + umk
КонецПроцедуры

// ===============================
Процедура УстНомерПО()
	НомерПО = РСчет.ПоследнийПрихДок + 1;
КонецПроцедуры

// ===============================
Процедура УстВидОперации() 
	
	// + umk
	Если ПустоеЗначение(СчетЗатрат) = 0 Тогда
		сВидОперации.ТекущаяСтрока(5);
		Возврат;
	КонецЕсли;
	// - umk

	Для Инд = 1 по сВидОперации.РазмерСписка() Цикл
		Если Найти(сВидОперации.ПолучитьЗначение(Инд),Строка(Счет)) <> 0 Тогда
			сВидОперации.ТекущаяСтрока(Инд);
			Возврат;
		КонецЕсли;
	КонецЦикла;
	Если НазваниеНабораПрав() = "Заказ" Тогда
	    сВидОперации.ТекущаяСтрока(1);
	Иначе
		сВидОперации.ТекущаяСтрока(2);
	КонецЕсли;
	
КонецПроцедуры

//======================================================================//--- УМК Сандомирский В.Ю. (08.09.14) курс
Процедура ИзмКурс()
	СуммаГрнПост = СуммаВал * Курс / Кратность;	
КонецПроцедуры // глИзмКурс()

// ===============================
Процедура ИзмСуммаВал()
	Ст = ВидНДС.Ставка.Получить(ДатаДок);
	НДС = СуммаВал * Ст / (1 + Ст);
	
	ИзмКурс();//--- УМК Сандомирский В.Ю. (08.09.14) курс
	
КонецПроцедуры

// ===============================
Процедура ИзмСубконто2()
	Если Счет.ВидСубконто(2) = ВидыСубконто.МесяцНачисленияЗП Тогда
		Если ПустоеЗначение(Субконто2) = 0 Тогда
		    Если Субконто2 <> НачМесяца(Субконто2) Тогда
				Субконто2 = НачМесяца(Субконто2);
			КонецЕсли;
		Иначе
			Субконто2 = НачМесяца(ДатаДок);
		КонецЕсли;
	ИначеЕсли Счет.ВидСубконто(2) = ВидыСубконто.Договора Тогда
		ДокументДоговор = Субконто2;
	КонецЕсли;
КонецПроцедуры

// ===============================
Процедура ИзмРСчет(ВводНового = 0)
	Если РСчет.Выбран() = 0 Тогда
		Возврат;
	КонецЕсли;
	Если НазваниеНабораПрав() = "Заказ" Тогда
		Если РСчет.ДоступЗаказ = 0 Тогда
			Предупреждение("По этой кассе вы не можете выписывать документы");
			РСчет = "";
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	//Если (НазваниеНабораПрав() = "ПроизводствоКасса") ИЛИ (НазваниеНабораПрав() = "ПроизводствоСбыт") Тогда //--- УМК Сандомирский В.Ю. (24.07.14) доступ к кассе "ПроизводствоКасса"
	Если (НазваниеНабораПрав() = "ПроизводствоСбыт") Тогда // + umk
		Если РСчет.ДоступПроизводствоКасса = 0 Тогда
			Предупреждение("По этой кассе вы не можете выписывать документы");
			РСчет = "";
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если Счет.ВидСубконто(2) = ВидыСубконто.Договора Тогда
		Если ПустоеЗначение(Субконто2) = 0 Тогда
			Попытка
				Если Субконто2.Валюта <> РСчет.Валюта Тогда
					Предупреждение("Выбранная Вами касса должна соответствовать валюте договоров!");
					РСчет = глПолучитьКассу(Фирма,Субконто2.Валюта);
				КонецЕсли;
			Исключение
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	Если РСчет.Выбран() = 1 Тогда
		Если РСчет.Безнал = 1 Тогда
			глКомментарий("Выбран безналичный счет!",1,,"!");
		КонецЕсли;
	КонецЕсли;
	Инфо = "";
	УстНомерПО();
	ИзмСчет(ВводНового);
	
	//--- УМК Сандомирский В.Ю. (08.09.14) Валюта
	Валюта 		= РСчет.Валюта;
	Курс 		= глКурсДляВалюты(Валюта,ДатаДок);
	Кратность 	= глКратностьДляВалюты(Валюта,ДатаДок);
	
	УстВидимостьСуммыГрн();
	УстановитьВидимость();// + umk
	
КонецПроцедуры

Процедура УстПринятоОт()
	Если ПустоеЗначение(Субконто1) = 0 Тогда
		Если Счет.ВидСубконто(1) = ВидыСубконто.Сотрудники Тогда
			ПринятоОт = СокрЛП(Субконто1.Наименование);
		ИначеЕсли Счет.ВидСубконто(1) = ВидыСубконто.Контрагенты Тогда
			ПринятоОт = Сокрлп(Субконто1.ПолнНаименование);
		КонецЕсли;
	КонецЕсли;	
КонецПроцедуры

// ===============================
Процедура ИзмСубконто1()
	Если ПустоеЗначение(Субконто1) = 1 Тогда
		Возврат;
	КонецЕсли;	
	Если Субконто1.Вид() = "Контрагенты" Тогда
		Если ПустоеЗначение(Субконто1)=0 Тогда
			// ручное изменение Контрагента
			Если СтарыйКонтрагент <> Субконто1 Тогда
				// только если изменили                         
				СуммаСНДС = 0;
				ДокументОснование = ПолучитьПустоеЗначение("Документ");
				Если ПустоеЗначение(Основание) = 0 Тогда
					Если Вопрос("Очистить текстовое поле ""Основание""?","Да+Нет")="Да" Тогда
						Основание = "";             
					КонецЕсли;
				КонецЕсли;
				Если РежимОплаты = Перечисление.РежимыОплаты.Автораспределение Тогда
					Субконто2 = ПолучитьПустоеЗначение("Документ.Договор");
				Иначе
					Если (глВосстановитьЗначение(,"ПодставлятьОсновнойДоговор")=Да)
					И (Субконто1.Вид() = "Контрагенты") Тогда
						// подставим договор по умолчанию
						Субконто2 = Субконто1.БазДоговор;
					Иначе
						// очистим договор
						Субконто2 = ПолучитьПустоеЗначение("Документ.Договор");
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		Иначе
			// нет контрагента, нет и договора, документа-основания
			Субконто2 = ПолучитьПустоеЗначение("Документ.Договор");
			ДокументОснование = ПолучитьПустоеЗначение("Документ");
			// и текст основания можно очистить
			Если ПустоеЗначение(Основание) = 0 Тогда
				Если Вопрос("Очистить текстовое поле ""Основание""?","Да+Нет")="Да" Тогда
					Основание = "";             
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		СтарыйКонтрагент = Субконто1;
	КонецЕсли;
	ПринятоОт = "";
	УстПринятоОт();
КонецПроцедуры

// ===========================
Функция ОстатокПоКассе()
Перем ТипИнфо;

	Если РСчет.Выбран() = 0 Тогда
        Возврат "";
	КонецЕсли;

	ТипыИнфо = СоздатьОбъект("СписокЗначений");
	ТипыИнфо.ДобавитьЗначение(1,"Остаток на начало дня");
	ТипыИнфо.ДобавитьЗначение(2,"Остаток на конец дня");
	ТипыИнфо.ВыбратьЗначение(ТипИнфо,"Выберите тип информации",2,0,1);
	
	ОстНач = 0; ОстКон = 0;

	Ит = СоздатьОбъект("БухгалтерскиеИтоги");
	Ит.ИспользоватьРазделительУчета(Фирма);
	Ит.ИспользоватьСубконто(ВидыСубконто.НашиДенежныеСчета, РСчет, 2);
	Ит.ВыполнитьЗапрос(ДатаДок,?(Выбран()=0,ДатаДок,ТекущийДокумент()),РСчет.СчетУчета,,,,,"СВ");
	
	Если РСчет.Валюта = Гривня Тогда
		ОстНач = Ит.СНД();
		ОстКон = Ит.СКД();
	Иначе
		Если Ит.ПолучитьВалюту(,РСчет.Валюта) = 1 Тогда
			ОстНач = Ит.СНД("В");
			ОстКон = Ит.СКД("В");
		КонецЕсли;
	КонецЕсли;
	
	Если ТипИнфо = 1 Тогда
		Инфо = "Ост. на нач. дня:" + РазделительСтрок + СокрЛП(Формат(ОстНач,"Ч12.2")) + " " + РСчет.Валюта.Кратко;
	ИначеЕсли ТипИнфо = 2 Тогда
		Инфо = "Ост. на кон. дня:" + РазделительСтрок + СокрЛП(Формат(ОстКон,"Ч12.2")) + " " + РСчет.Валюта.Кратко;
	КонецЕсли;
КонецФункции  

// ===========================
Функция ВалНаименование()
    Если РСчет.Выбран() = 1 Тогда
        Возврат СокрЛП(РСчет.Валюта.Кратко);
	Иначе
		Возврат СокрЛП("");
    КонецЕсли;
КонецФункции 

// ===============================
Процедура ПечатьОрдера(БыстраяПечать=0)
	Таб = СоздатьОбъект("Таблица"); 
	Таб.ИсходнаяТаблица("Ордер_Укр");
	глУстПропись(РСчет.Валюта,"У");           
	Таб.Вывести();
	Таб.Опции(0,0,0,0,"");
	Если БыстраяПечать=1 Тогда
		Таб.КоличествоЭкземпляров(глВосстановитьЗначение(,"ПечКолЭкзПрихОрдераПриБыстройПродаже"));
		Таб.Напечатать(0);
	Иначе
		Таб.Защита(Константа.ФлагЗащитыТаблиц);
		Таб.ТолькоПросмотр(1);
		Таб.Показать("Прибутковий касовий ордер","");
	КонецЕсли;	
	глУстПропись(Гривня);
КонецПроцедуры
              
// ===============================
Процедура ПечатьНаБланк()
	Таб = СоздатьОбъект("Таблица");    
	Таб.ИсходнаяТаблица("НаБланк_Укр");
	стрПринятоОт = "";
	Если Счет.КоличествоСубконто() > 0 Тогда
		Если ПустоеЗначение(Субконто1) = 0 Тогда
			стрПринятоОт = ?(Субконто1.Вид() = "Сотрудники", СокрЛП(Субконто1.Наименование),
 					?(Субконто1.Вид() = "Контрагенты", Субконто1.ПолнНаименование, Субконто1.Наименование));
		КонецЕсли; 					
	КонецЕсли;
	глУстПропись(Гривня,"У");
	// Если впечатывание работает неправильно, измените следующие настройки
	Ориентация = 1;			// ориентация вывода на печать: 1 - портрет, 2 - ландшафт
	Масштаб = 100;			// масштаб (в процентах) вывода на печать
	РежимПечатиКопий = 1;	// 0 - выводить сначала первые страницы копий, 1 - выводить страницы копий по порядку
    ПолеСлева = 7;			// расстояние (в миллиметрах) от левого края страницы
	ПолеСправа = 5;			// расстояние (в миллиметрах) от правого края страницы                                                                             
    ПолеСверху = 6;			// расстояние (в миллиметрах) от верхнего края страницы                                                                             
    ПолеСнизу = 10;			// расстояние (в миллиметрах) от нижнего края страницы
    // Конец задания настроек
	Таб.ПараметрыСтраницы(Ориентация,Масштаб,РежимПечатиКопий,ПолеСлева,ПолеСправа,ПолеСверху,ПолеСнизу,,);
	//
	СуммаЦел = ?(Цел(СуммаВал) < 1, "Нуль", Формат(Цел(СуммаВал),"ЧП"));
	СуммаКоп = (СуммаВал - Цел(СуммаВал)) * 100;                                          
	СуммаКоп = ?(СуммаКоп < 10,"0"+Строка(СуммаКоп),СуммаКоп);
	ДеньДок = ?(ДатаЧисло(ДатаДок) < 10,"0"+Строка(ДатаЧисло(ДатаДок)),ДатаЧисло(ДатаДок));
	МесяцДок = Сред(Формат(ДатаДок,"ДДДММММГГГГ"),Найти(Формат(ДатаДок,"ДДДММММГГГГ")," ")+1);
	МесяцДок = Сред(МесяцДок, 1, Найти(МесяцДок," ")-1);                                                                                           
	ГодДок = Сред(Строка(ДатаГод(ДатаДок)),3,2);
	//
	Таб.Вывести();        
	Таб.Опции(0,0,0,0,"");
	Таб.Показать("Приходный ордер для бланка строгой отчетности","");
	глУстПропись(Гривня);
КонецПроцедуры

// ===============================
Процедура ВыборВариантаПечати()
	Перем ВыбЗначение;
	ВариантыПечати = СоздатьОбъект("СписокЗначений");
	ВариантыПечати.ДобавитьЗначение(1,"Кассовый ордер");
	ВариантыПечати.ДобавитьЗначение(2,"Печать на бланк строгой отчетности");
	Если ВариантыПечати.ВыбратьЗначение(выбЗначение,"",,,1) <> 1 Тогда
	    Возврат;
	КонецЕсли;
	Если ВыбЗначение = 1 Тогда
	    ПечатьОрдера();
	ИначеЕсли ВыбЗначение = 2 Тогда
		ПечатьНаБланк();
	КонецЕсли;
КонецПроцедуры

// ======================================
Процедура ЗаполнитьПоУмолчанию()
	глЗаполнитьШапку(Контекст);
	РСчет = Константа.КассаПоУмолчанию; // + umk //глПолучитьКассу(Фирма,Гривня);
	Если РСчет.Выбран() = 1 Тогда
		НомерПО = РСчет.ПоследнийПрихДок + 1;
	КонецЕсли;
	ВидНДС = глВосстановитьЗначение(,"БазНДС");
	СубконтоВалДохРасх = Константа.НиДоходНиРасход;
	Кассир = Фирма.Кассир.Получить(ДатаДок);
	Если НазваниеНабораПрав() = "Заказ" Тогда
	    Счет = СчетПоКоду("361");
	КонецЕсли;
	Если Счет.Выбран() = 0 Тогда
		Счет = СчетПоКоду(?(РСчет.Валюта = Гривня, "37.2.1", "37.2.2"));
	КонецЕсли;
	ОперационнаяКР = 1;
	ВидОплаты = Перечисление.ВидыОплаты.Оплата;
	РежимОплаты = глВосстановитьЗначение(,"БазРежимОплаты");
	Если ПустоеЗначение(РежимОплаты)=1 Тогда
		РежимОплаты = Перечисление.РежимыОплаты.ПоСчету;
	КонецЕсли;
КонецПроцедуры 

// ===============================
Процедура ВводНового(ПризнакКопирования)
	Если ПризнакКопирования = 1 Тогда
		Если НазваниеНабораПрав() = "Администратор" Тогда
		    РСчет = Константа.КассаПоУмолчанию; // + umk //глПолучитьКассу(Фирма,Гривня);
		КонецЕсли;
		глУстановитьНомер(Контекст);
		Если РСчет.Выбран() = 1 Тогда
			НомерПО = РСчет.ПоследнийПрихДок + 1;
		КонецЕсли;
	    Возврат;
	КонецЕсли;
	ЗаполнитьПоУмолчанию();
	ИзмСчет(1);
	УстВидОперации();
КонецПроцедуры

// ===============================
Процедура Заполнить()
	
	ВалУч = Гривня;
	
	Если Лев(Счет.Код,2) = "36" Тогда
		// если вид операции - оплата заказа, ВидНДС возьмем из док.-основания,
	    Если ДокументОснование.Выбран() = 1 Тогда
			ВидНДС = ДокументОснование.ВидНДС;
		ИначеЕсли ПустоеЗначение(Субконто2) = 0 Тогда
			Если глЕстьРеквизитШапки("ВидНДС",Субконто2.Вид()) = Да Тогда
				// или из Договора, если ДокументОснование не выбран
	    		ВидНДС = Субконто2.ВидНДС;
	    	КонецЕсли;
    	КонецЕсли;
	КонецЕсли;

	Если ВидОплаты = Перечисление.ВидыОплаты.Оплата Тогда
		СуммаВал = глДолгКонтрагента(Контекст, -1, Фирма, Субконто1, Субконто2 ,ДокументОснование);
	Иначе
		СуммаВал = глДолгКонтрагента(Контекст, +1, Фирма, Субконто1, Субконто2 ,ДокументОснование);
	КонецЕсли;
	ИзмСуммаВал();
КонецПроцедуры

// ===============================
Процедура ВводНаОсновании(Знач ДокОснование)
Перем ДокВид, ВидыОснований;
	ЗаполнитьПоУмолчанию();
	
	ДокВид = ДокОснование.Вид();
	
	ВидКонтрагента = "Контрагенты";
	
	Если ДокВид = "РасходныйКассовый"  Тогда
		Если ДокОснование.ВидОплаты = Перечисление.ВидыОплаты.Возврат Тогда
		    СтатусВозврата(0);
			Предупреждение("Приходный ордер нельзя выписывать"+РазделительСтрок+
			               "на основании расходного ордера с признаком 'возврат'!");
			Возврат;
		КонецЕсли;
		ВидОплаты=Перечисление.ВидыОплаты.Возврат;
		Счет = ДокОснование.Счет;
		ИзмСчет(1);
		Субконто1 = ДокОснование.Субконто1;
		Субконто2 = ДокОснование.Субконто2;
		Субконто3 = ДокОснование.Субконто3;
	ИначеЕсли ДокВид = "РасходнаяНакладная" Тогда
		ВидОплаты = Перечисление.ВидыОплаты.Оплата;
		Док = СоздатьОбъект("Документ");
		Док.ВыбратьПодчиненныеДокументы(,,ДокОснование);
		Пока Док.ПолучитьДокумент() = 1 Цикл
			Если (Док.ПометкаУдаления() = 0) И (Док.Вид() = "ПриходныйКассовый") Тогда
				Сообщить("Для данной РН уже сформирован ПКО");
				СтатусВозврата(0);
				Возврат;
			КонецЕсли;
		КонецЦикла;
	ИначеЕсли ДокВид = "ВозвратнаяНакладная" Тогда
		ВидОплаты = Перечисление.ВидыОплаты.Возврат;
	ИначеЕсли ДокВид = "РасходнаяРозничная" Тогда
		ВидОплаты = Перечисление.ВидыОплаты.Оплата;
	ИначеЕсли ДокВид = "ВозвратРозница" Тогда
		ВидОплаты = Перечисление.ВидыОплаты.Возврат;
	ИначеЕсли ДокВид = "ОтчетКА" Тогда
		ВидОплаты = Перечисление.ВидыОплаты.Оплата;
	Иначе
		ВидОплаты = Перечисление.ВидыОплаты.Оплата;
	КонецЕсли;	

	Автор=глПользователь;
	ДатаДок=РабочаяДата();
	
	РежимОплаты = глВосстановитьЗначение(,"БазРежимОплаты");
	Если ПустоеЗначение(РежимОплаты)=1 Тогда
		РежимОплаты = Перечисление.РежимыОплаты.ПоСчету;
	КонецЕсли;
	
	Если Найти("ВводОстатковКредита,ПриходнаяНакладнаяЗапасы,ПриходнаяНакладнаяПрочие,
	|ПриходнаяНакладнаяГТД,РасходнаяНакладная,
	|СчетВходящий,РасходнаяРозничная,ОказаниеУслуг,
	|Договор",ДокВид) > 0 Тогда
		Счет = СчетПоКоду(?(РСчет.Валюта = Гривня, "36.1", "36.2"));
		ИзмСчет(1);
	КонецЕсли;	

	глЗаполнитьШапкуНаОсн(Контекст, ДокОснование);
	            
	Если ДокОснование.Вид() = "РасходнаяНакладная" Тогда	//--- УМК Сандомирский В.Ю, (09.03.15)
		Основание = СокрЛП(ДокОснование.ПредставлениеВида()) + " №"+Шаблон("[ДокОснование.НомерДок]") + " от " + Шаблон("[ДокОснование.ДатаДок]");;						
		ДокументОснование = ДокОснование; 
	КонецЕсли;	//... УМК Сандомирский В.Ю, (09.03.15)
	
	Если глЕстьРеквизитШапки("Контрагент",ДокВид) = Да Тогда
		НазначитьТип("Субконто1",ТипЗначенияСтр(ДокОснование.Контрагент));
		Субконто1 = ДокОснование.Контрагент;
		УстПринятоОт();
	КонецЕсли;	                                             
	
	Если глЕстьРеквизитШапки("Договор",ДокВид) = Да Тогда
		НазначитьТип("Субконто2",ТипЗначенияСтр(ДокОснование.Договор));
		Субконто2 = ДокОснование.Договор;
		ИзмСубконто2();
	КонецЕсли;	
	
	Если глЕстьРеквизитШапки("Валюта",ДокВид) = Да Тогда
		Валюта = ДокОснование.Валюта;
	Иначе
		Валюта = Гривня;
	КонецЕсли;	  
	
	Если глЕстьРеквизитШапки("КонечныйПотребитель",ДокВид) = Да Тогда
		КонечныйПотребитель = ДокОснование.КонечныйПотребитель;
	КонецЕсли;	  

	РСчет = ?(ДокВид = "ОтчетКА",ДокОснование.Касса,глПолучитьКассу(Фирма,Валюта));
	ИзмРСчет(1);    
	
	Если ДокВид = "ОтчетКА" Тогда
		Счет = СчетПоКоду("702");
		ИзмСчет(1);
		НазначитьТип("Субконто1",Счет.ВидСубконто(1));
		Субконто1 = глВосстановитьЗначение(,"БазВидДеятельности");
		ИзмСубконто1();
		НазначитьТип("Субконто2",ТипЗначенияСтр(ДокОснование.Подразделение));
		Субконто2 = ДокОснование.Подразделение;
		ИзмСубконто2();
		НазначитьТип("Субконто3",ТипЗначенияСтр(ДокОснование.МестоХранения));
		Субконто3 = ДокОснование.МестоХранения;
		Если Константа.ПроводкиПоКассеТолькоОрдерами = Нет Тогда
			НеПроводить = 1;
		КонецЕсли;	
	КонецЕсли;	
	
	//Заполнить();   
	
	Если (глЕстьРеквизитМнЧ("СуммаСНДС",ДокОснование.Вид()) = Да)
	ИЛИ (глЕстьРеквизитШапки("СуммаСНДС",ДокОснование.Вид()) = Да) Тогда
		Если СуммаВал = 0 Тогда
			СуммаВал = ДокОснование.Итог("СуммаСНДС");
			ИзмСуммаВал();
		КонецЕсли;
	ИначеЕсли ДокВид = "РасходныйКассовый" Тогда
		// реквизит в РасходныйКассовый называется СуммаВал
		СуммаВал = ДокОснование.СуммаВал;
		ИзмСуммаВал();
	КонецЕсли;
	
	УстВидОперации();
КонецПроцедуры

// ===============================
Процедура ПриОткрытии()
	
	Если (ТекущийДокумент().Выбран() = 1) и (НазваниеНабораПрав() = "Заказ") и (РСчет.ДоступЗаказ = 0) Тогда
		Предупреждение("Это не ваши ордера. Нечего на них смотреть!!!");
		СтатусВозврата(0);
		Возврат;
	КонецЕсли;
	
	//Если (ТекущийДокумент().Выбран() = 1) и (НазваниеНабораПрав() = "ПроизводствоКасса") и (РСчет.ДоступПроизводствоКасса = 0) Тогда //--- УМК Сандомирский В.Ю. (24.07.14) доступ к кассе "ПроизводствоКасса"
	//	Предупреждение("Это не ваши ордера. Нечего на них смотреть!!!");
	//	СтатусВозврата(0);
	//	Возврат;
	//КонецЕсли;
	
	
	НачальнаяДатаДокумента = ДатаДок;
	глПроверкаДатыДок(Контекст,"Открытие");
	ПриЗаписиПерепроводить(1);
	// Если открыли только на просмотр, то надо кнопки сделать недоступными
	Если Форма.ТолькоПросмотр()=1 Тогда
		//Форма.кОК.Доступность(0);
		//Форма.кПровести.Доступность(0);
		Форма.кЗаполнить.Доступность(0);
//		Форма.кДействия.Доступность(0);          
		
		Форма.кФирма.Доступность(0);               		
		//Форма.кОсн.Доступность(0);
		Форма.КнопкаПоУмолчанию("кЗакрыть");
	Иначе
		Форма.КнопкаПоУмолчанию("кОК");
	КонецЕсли;
	Форма.ИспользоватьЗакладки(1);
	Форма.Закладки.ДобавитьЗначение("Основной","Основные");
	Форма.Закладки.ДобавитьЗначение("Дополнительный","Дополнительно");
	Форма.ИспользоватьСлой("Общий,Основной"+УстСлои(),2);

	Форма.Счет.ВыборГруппы(0);
	сВидОперации.ДобавитьЗначение("361,362","Оплата заказа покупателем");
	сВидОперации.ДобавитьЗначение("","Прочие операции");
	сВидОперации.ДобавитьЗначение("3721,3722","Приход денег из подотчета");
	сВидОперации.ДобавитьЗначение("311,312,313,314","Поступление денег из банка");
	сВидОперации.ДобавитьЗначение("361,93","Эквайринг");//+ umk
	
	УстВидОперации();
	УстВидимостьСуммыГрн();
	
	СтарыйКонтрагент = Субконто1;  

	Если ПустоеЗначение(Форма.Параметр)=0 Тогда
		Если ТипЗначенияСтр(Форма.Параметр)="Строка" Тогда
			Если ВРег(Форма.Параметр)="БЫСТРАЯПЕЧАТЬ" Тогда
				//Если вызвано для из операции "быстрой продажи"
				ПечатьОрдера(1);
				СтатусВозврата(0); 
				Возврат;
			КонецЕсли;	
		КонецЕсли;	
	КонецЕсли;
	Если НазваниеНабораПрав() = "Заказ" Тогда
	    Форма.сВидОперации.Доступность(0);
		Форма.Счет.Доступность(0);
		Форма.НомерПО.Доступность(0);
	КонецЕсли;
	
	
	Если ((НазваниеНабораПрав() = "ПроизводствоКасса") ИЛИ (НазваниеНабораПрав() = "ПроизводствоСбыт")) И (Выбран() = 1) И (РСчет.ДоступПроизводствоКасса <> 1) Тогда	//--- УМК Сандомирский В.Ю. (28.07.14) доступ к кассе "ПроизводствоКасса"
	
		лкДок = Метаданные.Документ(Вид());
	    
	    Для ц=1 по лкДок.РеквизитШапки() Цикл
	        лкАтр = СокрЛП(лкДок.РеквизитШапки(ц).Идентификатор);
	        
			Если (лкАтр = "ДокументДоговор") 
				ИЛИ (лкАтр = "ДокументОснование") 
				ИЛИ (лкАтр = "РежимОплаты") 
				ИЛИ (лкАтр = "Ведомость") 
				ИЛИ (лкАтр = "ПоДаннымПродавца") 
				ИЛИ (лкАтр = "Кратность") Тогда
				Продолжить;
			КонецЕсли;
			
			Попытка
				 Шаблон("[Форма."+лкАтр+".Доступность(0)]");
			Исключение
			КонецПопытки;
	             
		КонецЦикла;
				
		Форма.сВидОперации.Доступность(0);
		//Форма.НДС.Доступность(0);
		//Форма.КонечныйПотребитель.Доступность(0);
		
		// --- Через формекс для примеро чтобы осталось может применю гденибуть    Formex //--- УМК Сандомирский В.Ю. (28.07.14)
		//ФормаРасш = СоздатьОбъект("РасширениеФормы"); 
		//ФормаРасш.УстановитьФорму(Форма);
		//Для Х = 0 По ФормаРасш.КоличествоАтрибутов() - 1 Цикл
		//  ФормаРасш.ПолучитьАтрибут(Х).Доступность = 0;
		//КонецЦикла;
		
	КонецЕсли;	
	
	Если ПустоеЗначение(Валюта) = 1 Тогда //--- УМК Сандомирский В.Ю. (09.09.14) Валюта
		Валюта 		= РСчет.Валюта;
		Курс 		= глКурсДляВалюты(Валюта,ДатаДок);
		Кратность 	= глКратностьДляВалюты(Валюта,ДатаДок);
	КонецЕсли;
	
	УстановитьВидимость();// + umk
	
КонецПроцедуры

// ===============================
Процедура ПриЗаписи()
	
	Если ((НазваниеНабораПрав() = "ПроизводствоКасса") ИЛИ (НазваниеНабораПрав() = "ПроизводствоСбыт")) И (Выбран() = 1) И (РСчет.ДоступПроизводствоКасса <> 1) Тогда	//--- УМК Сандомирский В.Ю. (28.07.14) доступ к кассе "ПроизводствоКасса"

	Иначе	
		Автор = глПользователь;
	КонецЕсли;
	
	Если РСчет.ПоследнийПрихДок < НомерПО Тогда
		Сч = СоздатьОбъект("Справочник.НашиДенежныеСчета");
		Сч.НайтиЭлемент(РСчет);
		Сч.ПоследнийПрихДок = НомерПО;
		Сч.Записать();
	КонецЕсли;
	//глПроверкаДатыДок(Контекст,"Запись");
	Если глКонтрольДатыДокумента(Контекст, НачальнаяДатаДокумента)=1 Тогда
		СтатусВозврата(0);
	КонецЕсли;
	// заполним реквизит ДокументДоговор, чтобы приходный кассовый был подчинен Договору
	Если ТипЗначенияСтр(Субконто2) = "Документ" Тогда
	    ДокументДоговор = Субконто2;
	КонецЕсли;
КонецПроцедуры

// ===============================
Процедура ПриНачалеВыбораЗначения(Рекв,ФлагСтандОбр)
	
	Если ((НазваниеНабораПрав() = "ПроизводствоКасса") ИЛИ (НазваниеНабораПрав() = "ПроизводствоСбыт")) И (Выбран() = 1) И (РСчет.ДоступПроизводствоКасса <> 1) Тогда	//--- УМК Сандомирский В.Ю. (28.07.14) доступ к кассе "ПроизводствоКасса"
		ФлагСтандОбр = 0;
		Возврат;
	КонецЕсли;
	
	Если Рекв = "ВидНДС" Тогда
	    глВыбратьНДС(Контекст,,1);
		ИзмВидНДС();
		ФлагСтандОбр = 0;
	ИначеЕсли Рекв = "ПринятоОт" Тогда
		ФлагСтандОбр = 0;
		Спр = СоздатьОбъект("Справочник.Сотрудники");
		Если Спр.Выбрать(,) = 1 Тогда
			ПринятоОт = СокрЛП(Спр.ТекущийЭлемент().Наименование);
		КонецЕсли;
	ИначеЕсли (Рекв = "Счет") и (Константа.ИспользоватьСписокКорректныхПроводок = Да) Тогда
		СписокКорректныхПроводок = СоздатьОбъект("СписокЗначений");
	    СписокКорректныхПроводок.Установить("Счет", СчетПоКоду("30"));
	    СписокКорректныхПроводок.Установить("Корреспонденция", 1);
		глЗначениеОтбора = СписокКорректныхПроводок;
	ИначеЕсли Рекв = "Субконто1" Тогда
		Если Счет.ВидСубконто(1) = ВидыСубконто.Сотрудники Тогда
			// подотчетные лица
			ФлагСтандОбр = 0;
			КонтФирма = Фирма;
			ОткрытьФорму("Справочник.Сотрудники.ДляВыбора",КонтФирма);
		КонецЕсли;
	ИначеЕсли Рекв = "Кассир" Тогда
		ФлагСтандОбр = 0;
		КонтФирма = Фирма;
		ОткрытьФорму("Справочник.Сотрудники.ДляВыбора",КонтФирма);
	КонецЕсли;
КонецПроцедуры

// ======================================
Процедура ИзмФирма()
	Если РСчет.Владелец <> Фирма Тогда
		РСчет = глПолучитьКассу(Фирма,Гривня);
		ИзмРСчет();
	КонецЕсли;
	Если Кассир.Выбран() = 1 Тогда
		Если Кассир.Фирма <> Фирма Тогда
			Кассир = Фирма.Кассир.Получить(ДатаДок);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры 

// ===============================
Процедура Взаиморасчеты()
	Если ВидОплаты = Перечисление.ВидыОплаты.Оплата Тогда
		// "Продажа"
		глПоказатьДолг(Контекст, Субконто1, "Продажа");
	ИначеЕсли ВидОплаты = Перечисление.ВидыОплаты.Возврат Тогда
		// "ВозвратПоставщику"
		глПоказатьДолг(Контекст, Субконто1, "Закупка");
	КонецЕсли;
КонецПроцедуры

// ===============================
Процедура ВыборОснования()
	// Процедура по кнопке редактирования основания в докумнете
	СтарДоговор = Субконто2;
	СтарОснование = ДокументОснование;
	
	глРасшифровка = СоздатьОбъект("СписокЗначений");
	глРасшифровка.Установить("Контрагент", "Субконто1");
	глРасшифровка.Установить("Договор", "Субконто2");
	глРасшифровка.Установить("ДокументОснование", "ДокументОснование");
	
	ОткрытьФормуМодально("Обработка.ОснованиеДокумента", Контекст);
	глРасшифровка = 0;
	
	Если ((ДокументОснование <> СтарОснование) и (ПустоеЗначение(ДокументОснование) = 0)) тогда
		ВводНаОсновании(ДокументОснование);	
	ИначеЕсли Субконто2<>СтарДоговор тогда
		// При вводе на основании Договор и Субконто2 могут быть очищены
		// поэтому запомним текущее значение договора
//		ВремДоговор = Субконто2;
//		ВводНаОсновании(Субконто2);
//		Субконто2 = ВремДоговор;
	КонецЕсли;	
	Если ПустоеЗначение(СуммаВал) = 1 Тогда
	    // запоняем только если пользователь не задал сумму
		Заполнить();
	КонецЕсли;                   
КонецПроцедуры	

//====================================================================== //--- УМК Сандомирский В.Ю, при выборе схемы руками оставляем пометку (26.05.14)
Процедура ИзмСхемаРБ()
	ФлРучногоИзмСхемыРБ = 1;
КонецПроцедуры // ИзмСхемаРБ

// ===============================
// Инициализируем список действий по кнопке "Действия"
СписокДействий = глПолучитьСписокДействий("
	|СтруктураПодчиненности,
	|ДвиженияДокумента,
	|ВводНаОсновании,
	|ОткрытьВЖурнале,
	|Подчиненные");
