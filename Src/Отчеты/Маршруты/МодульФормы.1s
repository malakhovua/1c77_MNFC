//======================================================================
Процедура ОбработатьДокументы(ВидДок, ТЗМ, СписМ, ТЗ)
	ДокРН = СоздатьОбъект("Документ." + ВидДок);
	ДокРН.УстановитьФильтр(1, 0);
	ДокРН.ВыбратьДокументы(НачДата, КонДата);
	ПредДата = Дата(0);	
	Пока ДокРН.ПолучитьДокумент() = 1 Цикл
		Если ВидДок = "СписаниеТМЦ" Тогда
			Если (ПустоеЗначение(ДокРН.ДокОснование) = 1) ИЛИ (ДокРН.ДокОснование.Вид() <> "УМК_ЗаказКлиента") Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		ТекКонтр = ?(ВидДок = "СписаниеТМЦ", ДокРН.ДокОснование.Контрагент, ДокРН.Контрагент);
		
		Если списКонтр.РазмерСписка() > 0 Тогда
			Если списКонтр.Принадлежит(ТекКонтр) = 0 Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если ПредДата <> ДокРН.ДатаДок Тогда
		    ТЗМ.УдалитьСтроки();

			Для Инд = 1 По СписМ.РазмерСписка() Цикл
				Маршрут = СписМ.ПолучитьЗначение(Инд);
				Если ПустоеЗначение(Маршрут) = 0 Тогда
					ДокМ = Маршрут.ДокМаршрута.Получить(ДокРН.ДатаДок);
					
					Идкс = 1;
					ДокМ.ВыбратьСтроки();
					Пока ДокМ.ПолучитьСтроку() = 1 Цикл
						ТЗМ.НоваяСтрока();
						ТЗМ.НомерМаршрута = Маршрут.Код;
						ТЗМ.Контрагент = ДокМ.Контрагент;
						ТЗМ.Договор = ДокМ.Договор;
						ТЗМ.Порядок = Идкс;
						
						Идкс = Идкс + 1;
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
			
			ПредДата = ДокРН.ДатаДок;
		КонецЕсли;
		
		ТекМаршрут = ?(ВидДок = "СписаниеТМЦ", ДокРН.ДокОснование.Маршрут, ДокРН.Маршрут);
		ТекДоговор = ?(ВидДок = "СписаниеТМЦ", ДокРН.ДокОснование.Договор, ДокРН.Договор); 
		Если списМаршрут.РазмерСписка() > 0 Тогда
			Если списМаршрут.Принадлежит(ТекМаршрут) = ?(фНЕМ = 1, 1, 0) Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		НомерМаршрута = 0;
		ТекстДляДоговора = "";
		ПорядокВМаршруте = 0;

		Если ПустоеЗначение(ТекМаршрут) = 0 Тогда
			НомерМаршрута = ТекМаршрут.Код;
			Стр = 0;
			Если ПустоеЗначение(ТекДоговор) = 0 Тогда
				Если ТЗМ.НайтиЗначение(ТекДоговор, Стр, "Договор") = 1 Тогда
					ПорядокВМаршруте = ТЗМ.ПолучитьЗначение(Стр, "Порядок");
				КонецЕсли;
			КонецЕсли;
			Если ПорядокВМаршруте = 0 Тогда
				Стр = 0;
				Если ТЗМ.НайтиЗначение(ТекКонтр, Стр, "Контрагент") = 1 Тогда
					ПорядокВМаршруте = ТЗМ.ПолучитьЗначение(Стр, "Порядок");				
				КонецЕсли;
			КонецЕсли;
			Если ПустоеЗначение(ТекДоговор) = 0 Тогда
				ТекстДляДоговора = глПолучитьТекстАдреса(ТекДоговор, ТекКонтр);//глАдресСтрокой(ДокРН.Договор.Адрес);
			Иначе
				Адр = глАдресСтрокой(ТекКонтр.ФизическийАдрес);
				Прим = СокрЛП(ДокРН.Примечание);
				ТекстДляДоговора = Прим + ?(Прим= "", Адр, " (" + Адр + ")");
			КонецЕсли;
		Иначе
			НомерМаршрута = -1;
			ПорядокВМаршруте = 0;
			ТекстДляДоговора = ?(ПустоеЗначение(ТекДоговор) = 1, ДокРН.Примечание, глПолучитьТекстАдреса(ТекДоговор, ТекКонтр));
		КонецЕсли;
			
		Если НомерМаршрута <> 0 Тогда
			ТЗ.НоваяСтрока();
			ТЗ.Контрагент = ТекКонтр;
			ТЗ.НомерМаршрута = ?(НомерМаршрута = -1, 0, НомерМаршрута);
			ТЗ.ПорядокВМаршруте = ПорядокВМаршруте;
			ТЗ.РН = ДокРН.ТекущийДокумент();
			ТЗ.ТекстДляДоговора = ТекстДляДоговора;				
			ТЗ.Вес = ?(ВидДок = "СписаниеТМЦ", ДокРН.Итог("Кво"), ДокРН.ИтогоВес); 
			ТЗ.ТекстДляДоговора = ТекстДляДоговора;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры // гл

//*******************************************
Процедура Сформировать()
	СписМ = СоздатьОбъект("СписокЗначений");
	СпрМ = СоздатьОбъект("Справочник.Маршруты");
	СпрМ.ВыбратьЭлементы();
	Пока СпрМ.ПолучитьЭлемент() = 1 Цикл
		Если СпрМ.ПометкаУдаления() = 0 Тогда
			Если списМаршрут.РазмерСписка() > 0 Тогда
				Если списМаршрут.Принадлежит(СпрМ.ТекущийЭлемент()) = ?(фНЕМ = 1, 1, 0) Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			СписМ.ДобавитьЗначение(СпрМ.ТекущийЭлемент());
		КонецЕсли;
	КонецЦикла;
	
	ТЗ = СоздатьОбъект("ТаблицаЗначений");
	ТЗ.НоваяКолонка("Контрагент", "Справочник.Контрагенты");
	ТЗ.НоваяКолонка("НомерМаршрута", "Число");
	ТЗ.НоваяКолонка("Маршрут", "Справочник.Маршруты");
	ТЗ.НоваяКолонка("ПорядокВМаршруте", "Число");
	//ТЗ.НоваяКолонка("РН", "Документ.РасходнаяНакладная");
	ТЗ.НоваяКолонка("РН", "Документ");
	//ТЗ.НоваяКолонка("Договор", "Документ.Договор");
	ТЗ.НоваяКолонка("ТекстДляДоговора", "Строка");
	ТЗ.НоваяКолонка("Вес", "Число", 15, 3);
	
	ТЗМ = СоздатьОбъект("ТаблицаЗначений");
	ТЗМ.НоваяКолонка("НомерМаршрута", "Число");
	ТЗМ.НоваяКолонка("Контрагент", "Справочник.Контрагенты");
	ТЗМ.НоваяКолонка("Договор", "Документ.Договор");
	ТЗМ.НоваяКолонка("Порядок", "Число");
	
	ОбработатьДокументы("РасходнаяНакладная", ТЗМ, СписМ, ТЗ);
	ОбработатьДокументы("СписаниеТМЦ", ТЗМ, СписМ, ТЗ);
	
	ТЗ.Сортировать("НомерМаршрута,ПорядокВМаршруте,Контрагент");
	
	Таб = СоздатьОбъект("Таблица");
	Таб.ВывестиСекцию("Шапка");
	ТЗ.ВыбратьСтроки();
	Пока ТЗ.ПолучитьСтроку() = 1 Цикл
		Ф1 = "";
		Если ТЗ.РН.Вид() = "РасходнаяНакладная" Тогда
			Ф1 = ?(ТЗ.РН.Ф1 = 1, "Х", "");
		КонецЕсли;
		Секц = Таб.ПолучитьСекцию("Строка");
		Если ТЗ.РН.МестоХранения <> ТЗ.РН.Фирма.ОсновнойСклад Тогда
			Секц.Область(, 1, , Таб.ШиринаТаблицы()).ЦветФона(255, 255, 183);
		КонецЕсли;
		//Таб.ВывестиСекцию("Строка");
		Таб.ВывестиСекцию(Секц);
	КонецЦикла;
	
	Таб.ПараметрыСтраницы(1,,,,,,,,,1);
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Маршруты по РН");	
КонецПроцедуры

Процедура ПоМаршрутам()
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Маршруты");
	Таб.ВывестиСекцию("Шапка");
	
	СпрМ = СоздатьОбъект("Справочник.Маршруты");	
	СпрМ.ВыбратьЭлементы();
	Пока СпрМ.ПолучитьЭлемент() = 1 Цикл
		Если СпрМ.ПометкаУдаления() = 0 Тогда
			Если списМаршрут.РазмерСписка() > 0 Тогда
				Если списМаршрут.НайтиЗначение(СпрМ.ТекущийЭлемент()) = 0 Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
			ДокМ = СпрМ.ДокМаршрута.Получить(КонДата);
			ДокМ.ВыбратьСтроки();
			Пока ДокМ.ПолучитьСтроку() = 1 Цикл
				Таб.ВывестиСекцию("Строка");
			КонецЦикла;
		КонецЕсли;				
	КонецЦикла;

	Таб.ПараметрыСтраницы(1,,,,,,,,,1);
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Маршруты по РН");		
КонецПроцедуры

Процедура ДобавитьВСписок(Элт, Наим, Спис)
	Если Спис.Принадлежит(Элт) = 0 Тогда
		Спис.ДобавитьЗначение(Элт, Наим);
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаПодбора(Элт)
	Если Элт.Вид() = "Маршруты" Тогда
		ДобавитьвСписок(Элт, Строка(Элт), списМаршрут);
	ИначеЕсли Элт.Вид() = "Контрагенты" Тогда
		ДобавитьвСписок(Элт, Строка(Элт), списКонтр);		
	КонецЕсли;
КонецПроцедуры

Процедура ДобавитьЭлементВСписок(НазваниеОбъекта, Один, ИмСп = "")
	ИмСпис = ИмСп;
	КФормы = 0;
	ОткрытьПодбор(НазваниеОбъекта, "ДляВыбора", КФормы, Один);
	Если Лев(НазваниеОбъекта, 1) = "С" Тогда
	    КФормы.ВыборГруппы(1);
	КонецЕсли;	
КонецПроцедуры

Процедура УдалитьЗначениеСписка(Спис)
	Если Спис.ТекущаяСтрока() <> 0 Тогда
		Спис.УдалитьЗначение(Спис.ТекущаяСтрока());
	КонецЕсли;
КонецПроцедуры

//======================================================================
Процедура КонтрагентыБезМ()
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("КонтрагентыБезМ");
	Таб.ВывестиСекцию("Шапка");
	СписКМ = СоздатьОбъект("СписокЗначений");
	СпрМ = СоздатьОбъект("Справочник.Маршруты");
	СпрМ.ВыбратьЭлементы(0);
	Пока СпрМ.ПолучитьЭлемент() = 1 Цикл
		Если СпрМ.ПометкаУдаления() = 0 Тогда
			ДокМ = СпрМ.ДокМаршрута.Получить(КонДата);
			ДокМ.ВыбратьСтроки();
			Пока ДокМ.ПолучитьСтроку() = 1 Цикл
				списКМ.ДобавитьЗначение(ДокМ.Контрагент);
			КонецЦикла;			
		КонецЕсли;
	КонецЦикла;
	
	СпрК = СоздатьОбъект("Справочник.Контрагенты");
	СпрК.ВыбратьЭлементы(0);
	Пока СпрК.ПолучитьЭлемент() = 1 Цикл
		Если СпрК.ПометкаУдаления() = 1 Тогда
			Продолжить;
		КонецЕсли;
		Если СпрК.ЭтоГруппа() = 0 Тогда
			Если СписКМ.НайтиЗначение(СпрК.ТекущийЭлемент()) <> 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Если списКонтр.РазмерСписка() > 0 Тогда
				Если списКонтр.Принадлежит(СпрК.ТекущийЭлемент()) = 0 Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
			Таб.ВывестиСекцию("Контрагент");
		КонецЕсли;			
	КонецЦикла;
	Таб.ПараметрыСтраницы(1,,,,,,,,,1);
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Маршруты по РН");			
КонецПроцедуры // КонтрагентыБезМ()

//======================================================================
Процедура СтараяФорма()
	СписМ = СоздатьОбъект("СписокЗначений");
	СпрМ = СоздатьОбъект("Справочник.Маршруты");
	СпрМ.ВыбратьЭлементы();
	Пока СпрМ.ПолучитьЭлемент() = 1 Цикл
		Если СпрМ.ПометкаУдаления() = 0 Тогда
			Если списМаршрут.РазмерСписка() > 0 Тогда
				Если списМаршрут.НайтиЗначение(СпрМ.ТекущийЭлемент()) = 0 Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			СписМ.ДобавитьЗначение(СпрМ.ТекущийЭлемент());
		КонецЕсли;
	КонецЦикла;
	
	ТЗ = СоздатьОбъект("ТаблицаЗначений");
	ТЗ.НоваяКолонка("Контрагент", "Справочник.Контрагенты");
	ТЗ.НоваяКолонка("НомерМаршрута", "Число");
	ТЗ.НоваяКолонка("ПорядокВМаршруте", "Число");
	ТЗ.НоваяКолонка("РН", "Документ.РасходнаяНакладная");
	//ТЗ.НоваяКолонка("Договор", "Документ.Договор");
	ТЗ.НоваяКолонка("ТекстДляДоговора", "Строка");
	ТЗ.НоваяКолонка("Вес", "Число", 15, 3);
	
	ДокРН = СоздатьОбъект("Документ.РасходнаяНакладная");
	ДокРН.УстановитьФильтр(1, 0);
	ДокРН.ВыбратьДокументы(НачДата, КонДата);
	ПредДата = Дата(0);	
	ТЗМ = СоздатьОбъект("ТаблицаЗначений");
	ТЗМ.НоваяКолонка("НомерМаршрута", "Число");
	ТЗМ.НоваяКолонка("Контрагент", "Справочник.Контрагенты");
	ТЗМ.НоваяКолонка("Договор", "Документ.Договор");
	ТЗМ.НоваяКолонка("Порядок", "Число");
	
	Пока ДокРН.ПолучитьДокумент() = 1 Цикл		
		Если ПредДата <> ДокРН.ДатаДок Тогда
		    ТЗМ.УдалитьСтроки();

			Для Инд = 1 По СписМ.РазмерСписка() Цикл
				Маршрут = СписМ.ПолучитьЗначение(Инд);
				ДокМ = Маршрут.ДокМаршрута.Получить(ДокРН.ДатаДок);
				
				Идкс = 1;
				ДокМ.ВыбратьСтроки();
				Пока ДокМ.ПолучитьСтроку() = 1 Цикл
					ТЗМ.НоваяСтрока();
					ТЗМ.НомерМаршрута = Маршрут.Код;
					ТЗМ.Контрагент = ДокМ.Контрагент;
					ТЗМ.Договор = ДокМ.Договор;
					ТЗМ.Порядок = Идкс;
					
					Идкс = Идкс + 1;
				КонецЦикла;
			КонецЦикла;
			
			ПредДата = ДокРН.ДатаДок;
		КонецЕсли;
		
		НомерМаршрута = 0;
		ТекстДляДоговора = "";
			
		Если ПустоеЗначение(ДокРН.Договор) = 0 Тогда
			Стр = 0;
			Если ТЗМ.НайтиЗначение(ДокРН.Договор, Стр, "Договор") = 1 Тогда
				НомерМаршрута = ТЗМ.ПолучитьЗначение(Стр, "НомерМаршрута");
				ПорядокВМаршруте = ТЗМ.ПолучитьЗначение(Стр, "Порядок");
				ТекстДляДоговора = глАдресСтрокой(ДокРН.Договор.Адрес);
			КонецЕсли;
		КонецЕсли;
			
		Если НомерМаршрута = 0 Тогда
			ТЗМ.ВыбратьСтроки();
			Пока ТЗМ.ПолучитьСтроку() = 1 Цикл
				Если (ПустоеЗначение(ТЗМ.Договор) = 1) И (ТЗМ.Контрагент = ДокРН.Контрагент) Тогда
					НомерМаршрута = ТЗМ.НомерМаршрута;
					ПорядокВМаршруте = ТЗМ.Порядок;
					ТекстДляДоговора = ДокРН.Примечание;
					Если ПустоеЗначение(ДокРН.Договор) = 1 Тогда
						Сообщить("Для контрагента: " + Строка(ДокРН.Контрагент) + " указан договор " + Строка(ДокРН.Договор) + ", не найденный в маршрутах");
					КонецЕсли;
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
			
		Если НомерМаршрута <> 0 Тогда
			ТЗ.НоваяСтрока();
			ТЗ.Контрагент = ДокРН.Контрагент;
			ТЗ.НомерМаршрута = НомерМаршрута;
			ТЗ.ПорядокВМаршруте = ПорядокВМаршруте;
			ТЗ.РН = ДокРН.ТекущийДокумент();
			ТЗ.ТекстДляДоговора = ТекстДляДоговора;				
			ТЗ.Вес = ДокРН.ИтогоВес;
			ТЗ.ТекстДляДоговора = ТекстДляДоговора;
		КонецЕсли;
	КонецЦикла;
	
	ТЗ.Сортировать("НомерМаршрута,ПорядокВМаршруте,Контрагент");
	
	Таб = СоздатьОбъект("Таблица");
	Таб.ВывестиСекцию("Шапка");
	ТЗ.ВыбратьСтроки();
	Пока ТЗ.ПолучитьСтроку() = 1 Цикл
		Таб.ВывестиСекцию("Строка");
	КонецЦикла;
	
	Таб.ПараметрыСтраницы(1,,,,,,,,,1);
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Маршруты по РН");		
КонецПроцедуры // СтараяФорма