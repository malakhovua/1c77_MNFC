Перем ВводНового;
Перем Записали;
Перем ВнКонтекст;

Процедура ПриначалеВыбораЗначения(Идент, Флаг)
	Если Идент = "Путь" Тогда
		Пт = СокрЛП(Путь);
		Если Пт = "" Тогда
			Пт = СокрЛП(Константа.ПутьФайловПоУмолчанию);
		КонецЕсли;
		Фл = "";
		Если ФС.ВыбратьФайл(0, Фл, Пт, "Выберите файл") = 1 Тогда
		    Путь = СокрЛП(Пт) + Фл;
		Иначе
			Возврат;
		КонецЕсли;
		Если СокрЛП(Путь) <> "" Тогда
			расш = ВРЕГ(Прав(СокрЛП(Путь), 3));
		    Если (расш = "BMP") или (расш = "JPG") Тогда
		        Картинка = 1;
		    КонецЕсли;
		КонецЕсли;
	ИначеЕсли Идент = "Категория" Тогда
		Флаг = 0;
		СпрКат = СоздатьОбъект("Справочник.ВидыКатегорий");
		СпрКат.НайтиПоНаименованию("Категории файлов");
		СпрКат.ИспользоватьРодителя(СпрКат.ТекущийЭлемент());
		СписКат = СоздатьОбъект("СписокЗначений");
		СпрКат.ВыбратьЭлементы();
		Пока СпрКат.ПолучитьЭлемент() = 1 Цикл
			Если СпрКат.ПометкаУдаления() = 0 Тогда
				СписКат.ДобавитьЗначение(СпрКат.ТекущийЭлемент());
			КонецЕсли;
		КонецЦикла;
		
		СписКат.ВыбратьЗначение(Категория, ,,,2);
	КонецЕсли;
КонецПроцедуры

// ===============================
Процедура ВводНового()	// предопределенная процедура
	ВводНового = 1;
КонецПроцедуры

// ===============================
Процедура ПриОткрытии()	// предопределенная процедура
    ВнКонтекст=Форма.Параметр;
КонецПроцедуры

// ===============================
Процедура ОбработкаВыбораЗначения(ВыбЗнач,ИдентЭлемДиалога, ФлагСтандОбр)	// Предопределенная процедура
КонецПроцедуры	// ОбработкаВыбораЗначения

// ===============================
Процедура ПриЗаписи()	// предопределенная процедура
	Записали = 1;
КонецПроцедуры	// ПриЗаписи

// ===============================
Процедура ПриЗакрытии()	// предопределенная процедура
	Перем Позиция;
	Если ТипЗначенияСтр(ВнКонтекст)="ГрупповойКонтекст" Тогда
		Если Записали = 1 Тогда
			Если ВводНового=1 Тогда
				// добавляем строку в список комплектующих набора
				ВнКонтекст.Файлы.НоваяСтрока();
				ВнКонтекст.Файлы.Ссылка = ТекущийЭлемент();
				ВнКонтекст.Файлы.Описание = Наименование;
				ВнКонтекст.Файлы.Категория = Категория;
				ВнКонтекст.Форма.кИзменитьФайл.Доступность(1);
				ВнКонтекст.Форма.кУдалитьФайл.Доступность(1);
			Иначе
				// обновляем строку в списке комплектующих
				Позиция = 0;
				ВнКонтекст.Файлы.НайтиЗначение(ТекущийЭлемент(),Позиция,"Ссылка");
				ВнКонтекст.Файлы.УстановитьЗначение(Позиция,"Описание",Наименование);
				ВнКонтекст.Файлы.УстановитьЗначение(Позиция,"Категория",Категория);
				ВнКонтекст.Файлы.ТекущаяСтрока(Позиция);
			КонецЕсли;
			ВнКонтекст.Файлы.Сортировать("Категория,Описание");
			ВнКонтекст.Форма.Обновить();
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры	// ПриЗакрытии

