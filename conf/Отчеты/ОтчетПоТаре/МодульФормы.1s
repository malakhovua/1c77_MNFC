Перем ИмСпис, Наим, СписокГруппировок, Запр, ТЗТМЦ;
Перем ТЗ;
Перем Обновить;
Перем Расшифровка;
Перем Закрыть;
Перем РСпискаМ, РСпискаР, РСпискаМа;
Перем ДокНачала, ДокКонца;
Перем Д1, Д2;


//Функция ВыполняетсяУсловие(РСписка, Спис, Что, Покупатель)
//	Если РСписка = 0 Тогда
//		ВУ = 1;
//	ИначеЕсли Покупатель.Вид() = "МестаХранения" Тогда
//		ВУ = 0;
//	ИначеЕсли Покупатель.Вид() = "Контрагенты" Тогда
//		ВУ = Спис.Принадлежит(Покупатель.ПолучитьАтрибут(Что));
//	КонецЕсли;
//	
//	Возврат ВУ;
//КонецФункции

Процедура ВывестиГруппировку(Таб, НомГрп);
	Зн = СписокГруппировок.ПолучитьЗначение(НомГрп);
	Значение = Запр.ПолучитьАтрибут(Зн);
	Наименование = Строка(Значение);
	
	Если Зн = "День" Тогда
		Если (Запр.КвоПриходК = 0) и (Запр.КвоПриходК1 = 0) и (Запр.КвоРасходК1 = 0) и (Запр.КвоРасходК1 = 0) Тогда
			Возврат;
		КонецЕсли;
	ИначеЕсли Зн = "Покупатель" Тогда
		Попытка
			Наименование = Значение.ПолнНаименование;
		Исключение
			Наименование = Строка(Значение);
		КонецПопытки;
		
	КонецЕсли;	
	
	Таб.ВывестиСекцию("Группировка"+НомГрп);
КонецПроцедуры

Функция ДобавитьГруппировки()
	СтрГруп = "";
	Наим = "";
	СписокГруппировок = СоздатьОбъект("СписокЗначений");
	Для Инд = 1 По ПорядокГруппировки.РазмерСписка() Цикл
		Нм = "";
		Зн = ПорядокГруппировки.ПолучитьЗначение(Инд, Нм);
		Если Шаблон("[ф"+Зн+"]") = "1" Тогда
			СтрГруп = СтрГруп + "
			|Группировка " + Зн;
			Если (Зн = "Покупатель") или (Зн = "Товар") Тогда
			    СтрГруп = СтрГруп + " упорядочить по " + Зн + ".Наименование без групп";
			КонецЕсли;
			СтрГруп = СтрГруп + ";";
			Наим = Наим + ?(СтрДлина(Наим) = 0, "", " / ") + Нм;
			СписокГруппировок.ДобавитьЗначение(Зн);
		КонецЕсли;
	КонецЦикла;
	
	Если фДок = 1 Тогда
		СтрГруп = СтрГруп + "
		|Группировка Док;";
		СписокГруппировок.ДобавитьЗначение("Док");
		Наим = Наим + " / Документ";
	КонецЕсли;
	
	Возврат СтрГруп;
КонецФункции

Функция ДобавитьУсловия()
	СтрУсл = "";
	Для Инд = 1 По ПорядокГруппировки.РазмерСписка() Цикл
		Зн = ПорядокГруппировки.ПолучитьЗначение(Инд);
		Если (Зн <> "Док") и (Зн <> "День") Тогда
			Если Шаблон("[спис" + Зн +".РазмерСписка()]") <> "0" Тогда
				СтрУсл = СтрУсл + "
				|Условие (" + Зн + " в спис"+Зн+");";
			КонецЕсли;
		КонецЕсли
	КонецЦикла;
	
	Возврат СтрУсл;
КонецФункции

Функция ПолучитьЗапрос()
	НачДата = Мин(НачДата, ПолучитьДатуТА());
	
	Если (КонДата >= ПолучитьДатуТА()) и (ПустоеЗначение(ДокКонца) = 1) Тогда
		ТекстЗапроса = "
			|Период с Д1;";
	Иначе 
		ТекстЗапроса = "
			|Период с Д1 по Д2;";
	КонецЕсли;
	глУстДатыОтчета(Д1, Д2, ДокНачала, ДокКонца, НачДата, КонДата);

	ТекстЗ =
	"//{{ЗАПРОС(ЗапрОбороты)" + 
	ТекстЗапроса + "
	|Фирма = Регистр.Партии.Фирма;
	|Товар = Регистр.Партии.ТМЦ;
	|Покупатель = Регистр.Партии.МестоХранения;
	|Док = Регистр.Партии.ТекущийДокумент;
	|Кво = Регистр.Партии.ОстатокТовара;
	|Функция КвоНачОстК = НачОст(Кво);
	//|Функция КвоПриходК = Приход(Кво) когда (Кво > 0);
	//|Функция КвоРасходК = Приход(Кво) когда (Кво < 0);
	|Функция КвоКонОстК = КонОст(Кво);
	|Функция КвоПриходК = Приход(Кво) когда (Кво > 0);
	|Функция КвоПриходК1 = Расход(Кво) когда ((Кво < 0) и (Покупатель.Вид() <> ""Контрагенты""));
	|Функция КвоРасходК = Приход(Кво) когда (Кво < 0);
	|Функция КвоРасходК1 = Расход(Кво) когда ((Кво > 0) и (Покупатель.Вид() <> ""Контрагенты""));"+
	ДобавитьГруппировки() + "
	|Условие(Товар.ВидТМЦ = Перечисление.ВидыТМЦ.Тара);" + 
	ДобавитьУсловия() + "
	|"//}}ЗАПРОС
	;
	
	Запр = СоздатьОбъект("Запрос");
	Если Запр.Выполнить(ТекстЗ) = 0 Тогда
		Возврат 0;
	Иначе
		ТЗ = СоздатьОбъект("ТаблицаЗначений");
		Запр.Выгрузить(ТЗ,0,0);
		Возврат 1;
	КонецЕсли;	
КонецФункции

//*******************************************
Процедура Сформировать()
	Расшифровка = СоздатьОбъект("СписокЗначений");
   	Расшифровка.Установить("Объект", "ОтчетПоТаре");
   	Расшифровка.Установить("Дата1", НачДата);
   	Расшифровка.Установить("Дата2", КонДата);
   	Расшифровка.Установить("списТовар", списТовар);
   	Расшифровка.Установить("списПокупатель", списПокупатель);
   	Расшифровка.Установить("ПорядокГруппировки", ПорядокГруппировки);
   	Расшифровка.Установить("фПокупатель", фПокупатель);
   	Расшифровка.Установить("фТовар", фТовар);
   	Расшифровка.Установить("фДок", фДок);
   	Расшифровка.Установить("фДень", фДень);
    Расшифровка.Установить("Обычный", "ВО");
	
   	Если ПолучитьЗапрос() = 0 Тогда
	    Возврат;
	КонецЕсли;

   	Таб = СоздатьОбъект("Таблица");
	
	Таб.ВывестиСекцию("Обновить");
	Расшифровка.УдалитьВсе();
	Таб.ВывестиСекцию("Заголовок");
	Таб.Опции(0,0,Таб.ВысотаТаблицы(), 8);
	Пока Запр.Группировка(1) = 1 Цикл
		ВывестиГруппировку(Таб, 1);
		Пока Запр.Группировка(2) = 1 Цикл
			ВывестиГруппировку(Таб, 2);
			Пока Запр.Группировка(3) = 1 Цикл
				ВывестиГруппировку(Таб, 3);
				Пока Запр.Группировка(4) = 1 Цикл
					ВывестиГруппировку(Таб, 4);
					Пока Запр.Группировка(5) = 1 Цикл
						ВывестиГруппировку(Таб, 5);
						Пока Запр.Группировка(6) = 1 Цикл
							ВывестиГруппировку(Таб, 6);
							Пока Запр.Группировка(7) = 1 Цикл
								ВывестиГруппировку(Таб, 7);
							КонецЦикла;
						КонецЦикла;
					КонецЦикла;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	Таб.ВывестиСекцию("Итого");

	Таб.ПараметрыСтраницы(2);
	Таб.Защита(Константа.ФлагЗащитыТаблиц);
	Таб.ТолькоПросмотр(1);
	Таб.Показать();
КонецПроцедуры

Процедура Сдвиг(Режим,Список)
	Перем ТекущПредставление;
	Перем СледующПредставление;
	
	ТекущаяСтрока=Список.ТекущаяСтрока();
	
	Если Режим="Вверх" Тогда
		Если ТекущаяСтрока=1 Тогда
			СледующСтрока=Список.РазмерСписка();
		Иначе
			СледующСтрока=ТекущаяСтрока-1;
		КонецЕсли;
	ИначеЕсли Режим="Вниз" Тогда
		Если ТекущаяСтрока=Список.РазмерСписка() Тогда
			СледующСтрока=1;
		Иначе
			СледующСтрока=ТекущаяСтрока+1;
		КонецЕсли;
	Иначе
		Возврат;
	КонецЕсли;
	
	ТекущЗначение=Список.ПолучитьЗначение(ТекущаяСтрока,ТекущПредставление);
	СледующЗначение=Список.ПолучитьЗначение(СледующСтрока,СледующПредставление);
	
	Список.УстановитьЗначение(СледующСтрока,ТекущЗначение,ТекущПредставление,1);
	Список.УстановитьЗначение(ТекущаяСтрока,СледующЗначение,СледующПредставление,1);
	
	Список.ТекущаяСтрока(СледующСтрока);

КонецПроцедуры   // Сдвиг

Процедура АктСверки()
	Если списПокупатель.РазмерСписка() = 0 Тогда
		Если Вопрос("Вы уверены, что хотите сформировать акты сверки для всех?", "Да+Нет") = "Нет" Тогда
			Возврат;
		КонецЕсли;	    
	КонецЕсли;
	
	фТовар = 1;
	фПокупатель = 1;
	фДень = 0;
	
	ПозТары = 0;
	ПозПок = 0;
	Для Инд = 1 по ПорядокГруппировки.РазмерСписка() Цикл
		Если ПорядокГруппировки.ПолучитьЗначение(Инд) = "Товар" Тогда
			ПозТары = Инд;
		ИначеЕсли ПорядокГруппировки.ПолучитьЗначение(Инд) = "Покупатель" Тогда
			ПозПок = Инд;
		КонецЕсли;
	КонецЦикла;
	
	Если ПозПок > ПозТары Тогда
		ПорядокГруппировки.ТекущаяСтрока(ПозТары);
		Для Инд = 1 По ПозПок - ПозТары Цикл
			Сдвиг("Вниз",ПорядокГруппировки);
		КонецЦикла;
	КонецЕсли;
	
	Если ПолучитьЗапрос() = 0 Тогда
	    Возврат;
	КонецЕсли;
	
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("АктСверки");
	Заголовок = "Тара" + ?(фДок = 1," / документ","");
	
	Инд = 1;
	Пока Запр.Группировка(1) = 1 Цикл
		Если Инд = 2 Тогда
		    Таб.НоваяСтраница();
		КонецЕсли;
		Таб.ВывестиСекцию("Шапка");
		Инд = Инд + 1;
		Если фДок =1 Тогда
		    Таб.ВывестиСекцию("Шапка2");
		КонецЕсли;
		Ном = 1;
		Пока Запр.Группировка(2) = 1 Цикл
			Таб.ВывестиСекцию("Строка");
			Ном = Ном + 1;
			Пока Запр.Группировка(3) = 1 Цикл
				Таб.ВывестиСекцию("Документ");
			КонецЦикла;
		КонецЦикла;
		Таб.ВывестиСекцию("Дно");		
	КонецЦикла;

	Таб.ПараметрыСтраницы(1);
	Таб.Защита(Константа.ФлагЗащитыТаблиц);
	Таб.ТолькоПросмотр(1);
	Таб.Показать();
КонецПроцедуры

Процедура ДобавитьВСписок(Элт, Спис)
	Если Спис.Принадлежит(Элт) = 0 Тогда
		Спис.ДобавитьЗначение(Элт, Элт.Наименование);
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаПодбора(Элт)
	Если Элт.Вид() = "Контрагенты" Тогда
		ДобавитьвСписок(Элт, списПокупатель);
	ИначеЕсли Элт.Вид() = "МестаХранения" Тогда
		ДобавитьвСписок(Элт, списПокупатель);
	ИначеЕсли Элт.Вид() = "ТМЦ" Тогда
		ДобавитьвСписок(Элт, списТовар);
	КонецЕсли;
КонецПроцедуры

Процедура ДобавитьЭлементВСписок(НазваниеОбъекта, Один, ИмСп = "")
	ИмСпис = ИмСп;
	КФормы = 0;
	ОткрытьПодбор(НазваниеОбъекта, "ДляВыбора", КФормы, Один);
	КФормы.ВыборГруппы(1);
КонецПроцедуры

Процедура УдалитьЗначениеСписка(Спис)
	Если Спис.ТекущаяСтрока() <> 0 Тогда
		Спис.УдалитьЗначение(Спис.ТекущаяСтрока());
	КонецЕсли;
КонецПроцедуры

Функция СформироватьТЗПоКат()
	ТЗ = СоздатьОбъект("ТаблицаЗначений");
	ТЗ.НоваяКолонка("Контр", "Справочник.Контрагенты");
	Если ВыбКат.Выбран() = 0 Тогда
		Предупреждение("Необходимо выбрать категорию");
		Возврат ТЗ;
	КонецЕсли;

	Спр = СоздатьОбъект("Справочник.КатегорииКонтрагентов");
	Спр.ВыбратьЭлементыПоРеквизиту("Категория", ВыбКат, 0, 0);
	Пока Спр.ПолучитьЭлемент() = 1 Цикл
		ТЗ.НоваяСтрока();
		ТЗ.Контр = Спр.Владелец;
	КонецЦикла;
	Возврат ТЗ;
КонецФункции

Процедура ДобавитьКонтрагентовПоКат(СписКонтр)
	ТЗ = СформироватьТЗПоКат();
	Если ТЗ.КоличествоСтрок() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для Инд = 1 По СписКонтр.РазмерСписка() Цикл
		ТЗ.НоваяСтрока();
		ТЗ.Контр = СписКонтр.ПолучитьЗначение(Инд);
	КонецЦикла;
	ТЗ.НоваяКолонка("Чис", "Число", 1);
	ТЗ.Свернуть("1", "Чис");
	ТЗ.Выгрузить(СписКонтр,,,"1");
КонецПроцедуры

Процедура УдалитьКонтрагентовПоКат(СписКонтр)
	ТЗ = СформироватьТЗПоКат();
	Если ТЗ.КоличествоСтрок() = 0 Тогда
		Возврат;
	КонецЕсли;

	Инд = 1;
	ТЗ.ВыбратьСтроки();
	Пока ТЗ.ПолучитьСтроку() = 1 Цикл
		Попытка
			СписКонтр.УдалитьЗначение(СписКонтр.НайтиЗначение(ТЗ.Контр));
		Исключение КонецПопытки;
	КонецЦикла;
КонецПроцедуры

Функция РасшифровкаОбновить(Обновить)
	Расшифровка.Установить("Обновить", Обновить);
	Возврат Расшифровка;
КонецФункции

Процедура ПриОткрытии()
	Если глФлагРасшифровки = 1 Тогда
		Закрыть = 1;
		Обновить = глОбновить;
	   	НачДата = глРасшифровка.Получить("Дата1");
	   	КонДата = глРасшифровка.Получить("Дата2");
	   	глРасшифровка.Получить("списПокупатель").Выгрузить(списПокупатель);
	   	глРасшифровка.Получить("списТовар").Выгрузить(списТовар);
	   	глРасшифровка.Получить("списПокупатель").Выгрузить(списПокупатель);
	   	глРасшифровка.Получить("ПорядокГруппировки").Выгрузить(ПорядокГруппировки);
	   	фПокупатель = глРасшифровка.Получить("фПокупатель");
	   	фРайон = глРасшифровка.Получить("фРайон");
	   	фДок = глРасшифровка.Получить("фДок");
	   	фТовар = глРасшифровка.Получить("фТовар");
	   	фДень = глРасшифровка.Получить("фДень");
	   	фСтМен = глРасшифровка.Получить("фСтМен");
	   	ВО = глРасшифровка.Получить("ВО");

	   	Если Обновить <> 0 Тогда
			Таб = глТаблица;
		КонецЕсли;

		Если Обновить <> 2 Тогда
	   		Сформировать();
			СтатусВозврата(0);
			Возврат;
		КонецЕсли;
	Иначе
	КонецЕсли;
КонецПроцедуры

НачДата = НачМесяца(ПолучитьДатуТА());
КонДата = ПолучитьДатуТА();	
ПорядокГруппировки.УдалитьВсе();
ПорядокГруппировки.ДобавитьЗначение("Товар","Тара");
ПорядокГруппировки.ДобавитьЗначение("Покупатель","Покупатель");
ПорядокГруппировки.ДобавитьЗначение("День","День");
